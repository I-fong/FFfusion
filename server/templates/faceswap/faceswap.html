{% extends "base.html" %}
{% block content %}
<form method="POST" action="/faceswap/swap/{{img_model.id}}">
  {% csrf_token %}
  <div>
    <div id="target_image_container" data-mydata="{{ target_bbox_json|safe }}"  style="position: relative;">
      {% if img_model.target_image %}
      <img class="bbox_image" id="target_image" src="{{ img_model.target_image.url }}">
    </div>
    <div>{{target_bbox_json}}</div>
    {% endif %}
  </div>
  <div>
    <div id="source_image_container" data-mydata="{{ source_bbox_json|safe }}" style="position: relative;">
      {% if img_model.source_image %}
      <img class="bbox_image" id="source_image" src="{{ img_model.source_image.url }}">
    </div>
    <div>{{source_bbox_json}}</div>
    {% endif %}
  </div>
  <button type="submit"> ìŠ¤ì™€í•‘í•˜ê¸° </button>
  {% if swapped_img_url %}
  <a>ê²°ê³¼ í™•ì¸ğŸ‘‡ğŸ»</a>
  <img class="bbox_image" src="{{ swapped_img_url }}">
  {% endif %}
</form>
<style>
  .bbox_image {
    max-height: 500px;  /* ì´ë¯¸ì§€ì˜ ìµœëŒ€ ë†’ì´ë¥¼ 100%ë¡œ ì„¤ì • */
    max-width: 500px; /* ì´ë¯¸ì§€ì˜ ìµœëŒ€ ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
    width: auto; /* ë„ˆë¹„ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì •í•˜ì—¬ ë¹„ìœ¨ ìœ ì§€ */
    height: auto; /* ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì •í•˜ì—¬ ë¹„ìœ¨ ìœ ì§€ */
    object-fit: contain; /* ì´ë¯¸ì§€ê°€ ì™„ì „íˆ ë°•ìŠ¤ ë‚´ì— ë§ê²Œ ì¡°ì •ë¨ */
  }
</style>
<!-- <script>
  document.addEventListener("DOMContentLoaded", function () {
    // HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const targetImageContainer = document.getElementById('target_image_container');
    const sourceImageContainer = document.getElementById('source_image_container');
    
    // data-mydata ì†ì„±ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const targetBboxList = JSON.parse(targetImageContainer.getAttribute('data-mydata'));
    const sourceBboxList = JSON.parse(sourceImageContainer.getAttribute('data-mydata'));
    
    function drawBoundingBoxes(container, bboxList, containerType) {
      for (let i = 0; i < bboxList.length; i++) {
          const bbox = bboxList[i];

          // Create a container div for the checkbox and image
          const contCheckbox = document.createElement("div");
          contCheckbox.className = "cont-checkbox";

          // Create the checkbox input element
          const checkboxInput = document.createElement("input");
          if (containerType == 'target'){
            checkboxInput.type = "checkbox";
            checkboxInput.id = `${containerType}-${i}`;
            checkboxInput.name = `${containerType}_checkbox`; // name ì†ì„± ì„¤ì •
            checkboxInput.value = i; // value ì†ì„± ì„¤ì •
            contCheckbox.className = "cont-checkbox";
          } else {
            checkboxInput.type = "radio";
            checkboxInput.id = `${containerType}-${i}`;
            checkboxInput.name = `${containerType}_checkbox`; // name ì†ì„± ì„¤ì •
            checkboxInput.value = i; // value ì†ì„± ì„¤ì •
            contCheckbox.className = "cont-checkbox";
          }         
                   

          // Create the label element for checkbox
          const label = document.createElement("label");
          label.htmlFor = `${containerType}-${i}`;

          // Create the span for checkbox cover
          const coverCheckbox = document.createElement("span");
          coverCheckbox.className = "cover-checkbox";

          // Create the SVG element for checkbox checkmark
          const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
          svg.setAttribute("viewBox", "0 0 12 10");
          // const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
          // polyline.setAttribute("points", "1.5 6 4.5 9 10.5 1");
          // svg.appendChild(polyline);

          // Create the div for info text
          const infoDiv = document.createElement("div");
          infoDiv.className = "info";
          infoDiv.textContent = "Object " + i; // Replace with the appropriate label

          // Set the position and size of the container div
          contCheckbox.style.position = "absolute";
          contCheckbox.style.left = bbox[0] + "px";
          contCheckbox.style.top = bbox[1] + "px";
          contCheckbox.style.width = (bbox[2] - bbox[0]) + "px";
          contCheckbox.style.height = (bbox[3] - bbox[1]) + "px";
          contCheckbox.style.border = "2px solid blue";

          // Append all elements to the container
          label.appendChild(contCheckbox);
          contCheckbox.appendChild(checkboxInput);

          // Add the container div to the specified container
          container.appendChild(label);

          // // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ê°ê°ì˜ ì‚¬ê°í˜•ì— ëŒ€í•´ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìƒì„±)
          // contCheckbox.addEventListener("click", createClickHandler(i));
      }
    }

    // // í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìƒì„± í•¨ìˆ˜
    // function createClickHandler(idx) {
    //     return function () {
    //         // í´ë¦­ëœ ì‚¬ê°í˜•ì˜ ì¢Œí‘œ ì¶œë ¥
    //         console.log("Clicked bbox:", idx);
    //     };
    // }

    // targetì™€ sourceì— ëŒ€í•´ BBox ê·¸ë¦¬ê¸°
    drawBoundingBoxes(targetImageContainer, targetBboxList, 'target');
    drawBoundingBoxes(sourceImageContainer, sourceBboxList, 'source');
  })
</script> -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // HTML ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const targetImageContainer = document.getElementById('target_image_container');
    const sourceImageContainer = document.getElementById('source_image_container');
    
    // data-mydata ì†ì„±ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const targetBboxList = JSON.parse(targetImageContainer.getAttribute('data-mydata'));
    const sourceBboxList = JSON.parse(sourceImageContainer.getAttribute('data-mydata'));
    console.log(targetBboxList)
    console.log(sourceBboxList)
    
    function drawBoundingBoxes(container, bboxList, containerType) {
      // ì´ë¯¸ì§€ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const image = container.querySelector('img');
          
      // ì´ë¯¸ì§€ì˜ ì›ë˜ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
      const originalImageWidth = image.naturalWidth;
      const originalImageHeight = image.naturalHeight;
      
      // ì´ë¯¸ì§€ì˜ í˜„ì¬ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
      const currentImageWidth = image.width;
      const currentImageHeight = image.height;
      
      // í¬ê¸° ë¹„ìœ¨ ê³„ì‚°
      const widthRatio = currentImageWidth / originalImageWidth;
      const heightRatio = currentImageHeight / originalImageHeight;

      for (let i = 0; i < bboxList.length; i++) {
          
          const bbox = bboxList[i];
          console.log(bboxList[i])

          // Create a container div for the checkbox and image
          const contCheckbox = document.createElement("div");
          contCheckbox.className = "cont-checkbox";

          // Create the checkbox input element
          const checkboxInput = document.createElement("input");
          if (containerType == 'target'){
            checkboxInput.type = "checkbox";
            checkboxInput.id = `${containerType}-${i}`;
            checkboxInput.name = `${containerType}_checkbox`; // name ì†ì„± ì„¤ì •
            checkboxInput.value = i; // value ì†ì„± ì„¤ì •
            contCheckbox.className = "cont-checkbox";
          } else {
            checkboxInput.type = "radio";
            checkboxInput.id = `${containerType}-${i}`;
            checkboxInput.name = `${containerType}_checkbox`; // name ì†ì„± ì„¤ì •
            checkboxInput.value = i; // value ì†ì„± ì„¤ì •
            contCheckbox.className = "cont-checkbox";
          }         
                   
          // Create the label element for checkbox
          const label = document.createElement("label");
          label.htmlFor = `${containerType}-${i}`;

          // Create the div for info text
          const infoDiv = document.createElement("div");
          infoDiv.className = "info";
          infoDiv.textContent = "Object " + i; // Replace with the appropriate label

          // bboxì˜ ì¢Œí‘œë¥¼ ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ì¡°ì •
          const adjustedX = bbox[0] * widthRatio;
          const adjustedY = bbox[1] * heightRatio;
          const adjustedWidth = (bbox[2] - bbox[0]) * widthRatio;
          const adjustedHeight = (bbox[3] - bbox[1]) * heightRatio;

          // Set the position and size of the container div
          contCheckbox.style.position = "absolute";
          contCheckbox.style.left = adjustedX + "px";
          contCheckbox.style.top = adjustedY + "px";
          contCheckbox.style.width = adjustedWidth + "px";
          contCheckbox.style.height = adjustedHeight + "px";
          contCheckbox.style.border = "2px solid blue";

          // Append all elements to the container
          label.appendChild(contCheckbox);
          contCheckbox.appendChild(checkboxInput);

          // Add the container div to the specified container
          container.appendChild(label);

          // // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ (ê°ê°ì˜ ì‚¬ê°í˜•ì— ëŒ€í•´ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìƒì„±)
          // contCheckbox.addEventListener("click", createClickHandler(i));
      }
    }

    // targetì™€ sourceì— ëŒ€í•´ BBox ê·¸ë¦¬ê¸°
    drawBoundingBoxes(targetImageContainer, targetBboxList, 'target');
    drawBoundingBoxes(sourceImageContainer, sourceBboxList, 'source');
  })
</script>
{% endblock %}
